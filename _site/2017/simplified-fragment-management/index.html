<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Simplified Fragment Management</title>
  <meta name="description" content="Android Developer. Gadget dependent. Music addicted.">
  <meta name="author" content="Dusko Bajic">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Dusko Bajic">
  <meta name="twitter:description" content="Android Developer. Gadget dependent. Music addicted.">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Dusko Bajic">
  <meta property="og:description" content="Android Developer. Gadget dependent. Music addicted.">

  <link rel="apple-touch-icon" sizes="57x57" href="/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="/images/favicons/manifest.json">
  <link rel="shortcut icon" href="/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="/images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="http://bajicdusko.com//2017/simplified-fragment-management/">
  <link rel="alternate" type="application/rss+xml" title="Dusko Bajic" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Dusko Bajic">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Dusko Bajic</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Android Developer. Gadget dependent. Music addicted.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Dusko Bajic blog" class="blog-button">Blog</a></li>
              <li class="navigation__item"><a href="/bio" title="link to Dusko Bajic contact" class="contact-button">Bio/Contact</a></li>
            </ul>
          </nav>
        </div>
        <div class="navigation-wrapper">
          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/bajicdusko" title="@bajicdusko on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/bajicdusko" title="bajicdusko on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/bajicdusko" title="bajicdusko on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            
              <!-- Email -->
              <li class="navigation__item">
                <a href="mailto:bajicdusko@gmail.com" title="Email bajicdusko@gmail.com" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="8 Jun 2017" class="post-meta__date date">8 Jun 2017</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#android">android</a> <a href="/tags/#fragment">fragment</a> <a href="/tags/#fragmentmanager">fragmentmanager</a> </span>
    </div>
    <h1 class="post-title">Simplified Fragment Management</h1>
  </header>

  <section class="post">
    <p>Handling fragments(lifecycle) in android app was complicated from the beginning.
Nowadays, a lot of internal bugs is fixed, but still there is a general negativity
towards fragment usage.</p>

<p>Many developers are avoiding fragments and returning to old fashion apps with the large
number of the activities. Just because it’s “complicated”, it
does not mean that we have to stop using it. Fragments are (at the moment) part of
our apps and we have to deal with it the best we can.</p>

<p>Ok then, we have to help ourself to handle the fragments as easier as possible.
By working on many apps, I’ve noticed few constant problem-patterns when it comes to fragments:</p>

<ol>
  <li>
    <p>Getting instance of Fragment (for whatever reason) from the existing stack of transactions, regardless of the position in the stack.</p>

    <p>One way of getting the last added fragment might be this one:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">//fetching all fragments</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getFragments</span><span class="o">();</span>

<span class="c1">//getting last added fragment</span>
<span class="n">Fragment</span> <span class="n">currentFragment</span> <span class="o">=</span> <span class="n">fragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fragments</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</code></pre>
    </div>

    <p>Although this approach makes sense, it is possible that some fragments are removed in the meantime and this list will contain <code class="highlighter-rouge">null</code> (instead of trimmed size).</p>

    <p>If for example we have <code class="highlighter-rouge">three</code> fragments on stack and we just tapped back button, we might get <code class="highlighter-rouge">fragment.size() == 3</code> but
actual number of fragments is <code class="highlighter-rouge">two</code> and <code class="highlighter-rouge">fragments.get(fragments.size() - 1)</code> will return <code class="highlighter-rouge">null</code>.</p>

    <p>And I cannot point the obvious more than it is, but <strong>this is the stack</strong> and still it can happen with any other index in the list. Since we have a <code class="highlighter-rouge">List&lt;&gt;</code> interface exposed, then we can call <code class="highlighter-rouge">fragments.get(0)</code> and wow, it returns <code class="highlighter-rouge">null</code>, <code class="highlighter-rouge">fragments.size()</code> value will be incorrect and no matter what index we use, we won’t get correct fragment instance.</p>

    <p>Then we might say, ok we can use this approach instead:</p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="c1">//fetching all fragments</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getFragments</span><span class="o">();</span>

<span class="c1">//getting the actual number of fragments from the fragmentManager</span>
<span class="kt">int</span> <span class="n">fragmentsCount</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getBackStackEntryCount</span><span class="o">();</span>

<span class="c1">//getting last added fragment</span>
<span class="n">Fragment</span> <span class="n">currentFragment</span> <span class="o">=</span> <span class="n">fragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fragmentsCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</code></pre>
    </div>

    <p>And great, now we have the exact number of fragments on the stack, however, <code class="highlighter-rouge">fragments</code> list
still can contain <code class="highlighter-rouge">null</code> values on any position and we’ll end up with wrong fragment or with <code class="highlighter-rouge">java.lang.IndexOutOfBoundsException</code> in the worst case. Additional work is needed anyway and it seams its a lot
of work just to get instance of fragment we have created in the first place.</p>
  </li>
  <li>
    <p>Handling onBackPressed navigation and application title update</p>

    <p>Typical android application shows <code class="highlighter-rouge">Toolbar</code> on top of the screen. If the <code class="highlighter-rouge">Toolbar</code> is part of the <code class="highlighter-rouge">Activity</code> layout
we need to update its <code class="highlighter-rouge">title</code> according to currently active fragment.</p>

    <p>For example:</p>

    <p><code class="highlighter-rouge">HomeActivity.java</code></p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="nd">@Inject</span> <span class="n">FragmentManager</span> <span class="n">supportFragmentManager</span><span class="o">;</span>
<span class="nd">@BindView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">toolbar</span><span class="o">)</span> <span class="n">Toolbar</span> <span class="n">toolbar</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">){</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>

  <span class="n">setSupportActionBar</span><span class="o">(</span><span class="n">toolbar</span><span class="o">);</span>
  <span class="n">supportFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
             <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">activity_home_fragment_container</span><span class="o">,</span> <span class="n">LoginFragment</span><span class="o">.</span><span class="na">newInstance</span><span class="o">())</span>
             <span class="o">.</span><span class="na">addToBackStack</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
             <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="p">(</span><span class="nd">@StringRes</span> <span class="kt">int</span> <span class="n">titleId</span><span class="o">){</span>
  <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">titleId</span><span class="o">));</span>
<span class="o">}</span>
</code></pre>
    </div>

    <p><code class="highlighter-rouge">LoginFragment.java</code></p>

    <div class="highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
 <span class="kd">public</span> <span class="kt">void</span> <span class="n">onStart</span><span class="o">()</span> <span class="o">{</span>
     <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
     <span class="o">((</span><span class="n">HomeActivity</span><span class="o">)</span><span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">login</span><span class="o">);</span>
 <span class="o">}</span>
</code></pre>
    </div>

    <p>And this actually works. Except you might get <code class="highlighter-rouge">NullPointerException</code> sometimes or <code class="highlighter-rouge">java.lang.IllegalStateException: Fragment LoginFragment not attached to Activity</code> and honestly I’ve stopped looking for reasons why. If you move <code class="highlighter-rouge">getActivity().setTitle(R.string.login);</code> to some other location in the fragment, <code class="highlighter-rouge">setTitle</code> might get called too late and we’re triggering bad user experience.</p>

    <p>On the other hand, when you’re popping the fragment from the stack, <code class="highlighter-rouge">setTitle()</code> might not get called at all, and you end up with <code class="highlighter-rouge">title</code> in the <code class="highlighter-rouge">Toolbar</code> that does not match the content.</p>
  </li>
  <li>
    <p>Reseting stack triggers lifecycle of each fragment along the way</p>

    <p>At some point, we have to return to the starting point of the app. So we’ll be popping the fragments from the stack
until stack gets empty or until there is only one fragment shown. Not so obvious problem that occurs is that
each popped fragment gets re-instantiated with call to all lifecycle methods, and causing execution of logic we put in
each fragment. This is definitely unwanted behavior. We just want to remove them so that we can start from the beginning.</p>
  </li>
  <li>
    <p>Communication between fragments and the hosting Activity</p>
  </li>
</ol>

<script src="https://gist.github.com/bajicdusko/683766ab74b93519be27df0ae6e0793f.js"></script>


  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://bajicdusko.com/2017/simplified-fragment-management/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2017/simplified-fragment-management'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//bajicdusko.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Dusko Bajic. All rights reserved.</span>
</footer> 

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>

    </div>
  </body>
</html>
