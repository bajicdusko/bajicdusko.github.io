<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Simplified Fragment Management</title>
  <meta name="description" content="Android Developer. Gadget dependent. Music addicted.">
  <meta name="author" content="Dusko Bajic">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:title" content="Simplified Fragment Management">
  
  
  <meta name="twitter:description" content="SimpleFragmentManager is basically a wrapper around FragmentManager and exposes 'add', 'replace', 'popUp', 'onBackPressed' and 'getCurrentFragment' methods. SimpleFragmentManager assumes that...">
  
  <meta name="twitter:site" content="@bajicdusko">

  <meta property="og:type" content="article">
  <meta property="og:title" content="Dusko Bajic">
  <meta property="og:description" content="Android Developer. Gadget dependent. Music addicted.">
  <meta property="test:githuburl" content="">
  <meta property="test:url" content="http://localhost:4000">
  <meta property="test:baseurl" content="/">

  <link rel="apple-touch-icon" sizes="57x57" href="http://localhost:4000/images/favicons/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="http://localhost:4000/images/favicons/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/images/favicons/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="http://localhost:4000/images/favicons/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/images/favicons/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="http://localhost:4000/images/favicons/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/images/favicons/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="http://localhost:4000/images/favicons/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/images/favicons/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicons/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicons/favicon-194x194.png" sizes="194x194">
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicons/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicons/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="http://localhost:4000/images/favicons/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="http://localhost:4000/images/favicons/manifest.json">
  <link rel="shortcut icon" href="http://localhost:4000/images/favicons/favicon.ico">
  <meta name="msapplication-TileColor" content="#ffc40d">
  <meta name="msapplication-TileImage" content="http://localhost:4000{"prepend"=>"/"}images/favicons/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="http://localhost:4000/css/main.css">
  <link rel="canonical" href="http://localhost:4000//2017/simplified-fragment-management/">
  <link rel="alternate" type="application/rss+xml" title="Dusko Bajic" href="/feed.xml">
</head>


  <body>
    <span class="mobile btn-mobile-menu">
  <i class="icon icon-list btn-mobile-menu__icon"></i>
  <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
</span>

<header class="panel-cover" style="background-image: url(/images/cover.jpg)">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">
        <a href="/" title="link to home of Dusko Bajic">
          <img src="/images/profile.jpg" class="user-image" alt="My Profile Photo">
          <h1 class="panel-cover__title panel-title">Dusko Bajic</h1>
        </a>
        <hr class="panel-cover__divider">
        <p class="panel-cover__description">Android Developer. Gadget dependent. Music addicted.</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary">

        <div class="navigation-wrapper">
          <nav class="cover-navigation cover-navigation--primary">
            <ul class="navigation">
              <li class="navigation__item"><a href="/#blog" title="link to Dusko Bajic blog" class="blog-button">Blog</a></li>
              <li class="navigation__item"><a href="/bio" title="link to Dusko Bajic contact" class="contact-button">Bio/Contact</a></li>
            </ul>
          </nav>
          <nav class="cover-navigation navigation--social">
            <ul class="navigation">

            
              <!-- Twitter -->
              <li class="navigation__item">
                <a href="http://twitter.com/bajicdusko" title="@bajicdusko on Twitter" target="_blank">
                  <i class="icon icon-social-twitter"></i>
                  <span class="label">Twitter</span>
                </a>
              </li>
            

            

            
              <!-- LinkedIn -->
              <li class="navigation__item">
                <a href="https://www.linkedin.com/in/bajicdusko" title="bajicdusko on LinkedIn" target="_blank">
                  <i class="icon icon-social-linkedin"></i>
                  <span class="label">LinkedIn</span>
                </a>
              </li>
            

            
              <!-- GitHub -->
              <li class="navigation__item">
                <a href="https://www.github.com/bajicdusko" title="bajicdusko on GitHub" target="_blank">
                  <i class="icon icon-social-github"></i>
                  <span class="label">GitHub</span>
                </a>
              </li>
            

            
              <!-- Email -->
              <li class="navigation__item">
                <a href="mailto:bajicdusko@gmail.com" title="Email bajicdusko@gmail.com" target="_blank">
                  <i class="icon icon-mail"></i>
                  <span class="label">Email</span>
                </a>
              </li>
            

            <!-- RSS -->
            <li class="navigation__item">
              <a href="/feed.xml" title="Subscribe" target="_blank">
                <i class="icon icon-rss"></i>
                <span class="label">RSS</span>
              </a>
            </li>

            </ul>
          </nav>

        </div>

      </div>

    </div>

    <div class="panel-cover--overlay"></div>
  </div>
</header>


    <div class="content-wrapper">
      <div class="content-wrapper__inner">
        <article class="post-container post-container--single">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="8 Jun 2017" class="post-meta__date date">8 Jun 2017</time> &#8226; <span class="post-meta__tags">on <a href="/tags/#android">android</a> <a href="/tags/#fragment">fragment</a> <a href="/tags/#fragmentmanager">fragmentmanager</a> </span>
    </div>
    <h1 class="post-title">Simplified Fragment Management</h1>
  </header>

  <section class="post">
    <p>Handling fragments(lifecycle) in android app was complicated from the beginning.
Nowadays, a lot of internal bugs is fixed, but still there is a general negativity
towards fragment usage.</p>

<p>Many developers are avoiding fragments and returning to old fashion apps with the large
number of the activities. Just because it’s “complicated”, it
does not mean that we have to stop using it. Fragments are (at the moment) part of
our apps and we have to deal with it the best we can.</p>

<p>These issues might feel a little bit basic, however, by working on many android apps, I’ve noticed few constant problem-patterns (listed-below) when it comes to fragments. If you’d just like to jump to implementation, <a href="#solution">click here</a>.</p>

<ol>
  <li>
    <p><strong>Getting instance of Fragment</strong> (for whatever reason) from the existing stack of transactions, regardless of the position in the stack.</p>

    <p>One way of getting the last added fragment might be this one:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//fetching all fragments</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getFragments</span><span class="o">();</span>

<span class="c1">//getting last added fragment</span>
<span class="n">Fragment</span> <span class="n">currentFragment</span> <span class="o">=</span> <span class="n">fragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fragments</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</code></pre>
    </div>

    <p>Although this approach makes sense, it is possible that some fragments are removed in the meantime and this list will contain <code class="highlighter-rouge">null</code> (instead of trimmed size).</p>

    <p>If, for example, we have <code class="highlighter-rouge">three</code> fragments on stack and we just tapped back button, we might get <code class="highlighter-rouge">fragment.size() == 3</code> but
actual number of fragments is <code class="highlighter-rouge">two</code> and third position <code class="highlighter-rouge">fragments.get(fragments.size() - 1)</code> will return <code class="highlighter-rouge">null</code>.</p>

    <p>And I cannot point the obvious more than it is, but <strong>this is the stack</strong> and still it can happen with any other index in the list. Since we have a <code class="highlighter-rouge">List&lt;&gt;</code> interface exposed, then we can call <code class="highlighter-rouge">fragments.get(0)</code> and wow, it returns <code class="highlighter-rouge">null</code>, <code class="highlighter-rouge">fragments.size()</code> value will be incorrect and no matter what index we use, we won’t get correct fragment instance.</p>

    <p>Then we might say, ok we can use this approach instead:</p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="c1">//fetching all fragments</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Fragment</span><span class="o">&gt;</span> <span class="n">fragments</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getFragments</span><span class="o">();</span>

<span class="c1">//getting the actual number of fragments from the fragmentManager</span>
<span class="kt">int</span> <span class="n">fragmentsCount</span> <span class="o">=</span> <span class="n">fragmentManager</span><span class="o">.</span><span class="na">getBackStackEntryCount</span><span class="o">();</span>

<span class="c1">//getting last added fragment</span>
<span class="n">Fragment</span> <span class="n">currentFragment</span> <span class="o">=</span> <span class="n">fragments</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fragmentsCount</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</code></pre>
    </div>

    <p>And great, now we have the exact number of fragments on the stack, however, <code class="highlighter-rouge">fragments</code> list
still can contain <code class="highlighter-rouge">null</code> values on any position and we’ll end up with wrong fragment or with <code class="highlighter-rouge">java.lang.IndexOutOfBoundsException</code> in the worst case. Additional work is needed anyway and it seams its a lot
of work just to get instance of fragment we have created in the first place.</p>
  </li>
  <li>
    <p><strong>Handling onBackPressed navigation and application title update</strong></p>

    <p>Typical android application shows <code class="highlighter-rouge">Toolbar</code> on top of the screen. If the <code class="highlighter-rouge">Toolbar</code> is part of the <code class="highlighter-rouge">Activity</code> layout
we need to update its <code class="highlighter-rouge">title</code> according to currently active fragment.</p>

    <p>For example:</p>

    <p><code class="highlighter-rouge">HomeActivity.java</code></p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Inject</span> <span class="n">FragmentManager</span> <span class="n">supportFragmentManager</span><span class="o">;</span>
<span class="nd">@BindView</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">toolbar</span><span class="o">)</span> <span class="n">Toolbar</span> <span class="n">toolbar</span><span class="o">;</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="n">Bundle</span> <span class="n">savedInstanceState</span><span class="o">){</span>
  <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
  <span class="o">...</span>
  <span class="n">setSupportActionBar</span><span class="o">(</span><span class="n">toolbar</span><span class="o">);</span>
  <span class="n">supportFragmentManager</span><span class="o">.</span><span class="na">beginTransaction</span><span class="o">()</span>
             <span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">activity_home_fragment_container</span><span class="o">,</span> <span class="n">HomeFragment</span><span class="o">.</span><span class="na">newInstance</span><span class="o">())</span>
             <span class="o">.</span><span class="na">addToBackStack</span><span class="o">(</span><span class="kc">null</span><span class="o">)</span>
             <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTitle</span><span class="o">(</span><span class="nd">@StringRes</span> <span class="kt">int</span> <span class="n">titleId</span><span class="o">){</span>
  <span class="n">getSupportActionBar</span><span class="o">().</span><span class="na">setTitle</span><span class="o">(</span><span class="n">getString</span><span class="o">(</span><span class="n">titleId</span><span class="o">));</span>
<span class="o">}</span>
</code></pre>
    </div>

    <p><code class="highlighter-rouge">HomeFragment.java</code></p>

    <div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStart</span><span class="o">()</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onStart</span><span class="o">();</span>
   <span class="o">((</span><span class="n">HomeActivity</span><span class="o">)</span><span class="n">getActivity</span><span class="o">()).</span><span class="na">setTitle</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">string</span><span class="o">.</span><span class="na">home</span><span class="o">);</span>
<span class="o">}</span>
</code></pre>
    </div>

    <p>And this actually works. Except you might get <code class="highlighter-rouge">NullPointerException</code> sometimes or <code class="highlighter-rouge">java.lang.IllegalStateException: Fragment LoginFragment not attached to Activity</code> and honestly, I’ve stopped looking for reasons why. If you move <code class="highlighter-rouge">getActivity().setTitle(R.string.login);</code> to some other location in the fragment, <code class="highlighter-rouge">setTitle</code> might get called too late and we’re triggering bad user experience.</p>

    <p>On the other hand, when you’re popping the fragment from the stack, you have to call <code class="highlighter-rouge">setTitle()</code> method of the <code class="highlighter-rouge">Fragment</code> which is popping up and at some point <code class="highlighter-rouge">setTitle()</code> method might not get called at all, and you end up with <code class="highlighter-rouge">title</code> in the <code class="highlighter-rouge">Toolbar</code> that does not match the content.</p>

    <p>It does not have to be the title, you might want to change navigation options for different fragments, to show back arrow instead of hamburger icon etc, and setting these options will depend of some method call inside the <code class="highlighter-rouge">Fragment</code>.</p>
  </li>
  <li>
    <p><strong>Reseting stack</strong> triggers lifecycle of each fragment along the way</p>

    <p>At some point, we have to return to the starting point of the app. So we’ll be popping the fragments from the stack
until stack gets empty or until there is only one fragment shown. Not so obvious problem that occurs is that
each popped fragment gets re-instantiated with call to all lifecycle methods, and causing execution of logic we put in
each fragment. This is definitely unwanted behavior. We just want to remove them so that we can start from the beginning.</p>
  </li>
  <li>
    <p><strong>Communication</strong> between fragments and the hosting Activity should not be implemented by casting <code class="highlighter-rouge">getActivity()</code> method and I like to think that no one implements it like that. Instead, communication between activity and the fragments should be implemented via interface which <code class="highlighter-rouge">Activity</code> implements, I know, obvious.</p>
  </li>
</ol>

<p><a name="solution">Simple solution</a> I came up with have four main components:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">SimpleFragmentManager</code> which is basically a wrapper around <code class="highlighter-rouge">FragmentManager</code> and exposes the methods for <code class="highlighter-rouge">add</code>, <code class="highlighter-rouge">replace</code>, <code class="highlighter-rouge">popUp</code>, <code class="highlighter-rouge">popUpAll</code> and <code class="highlighter-rouge">getCurrentFragment</code> operations. <code class="highlighter-rouge">SimpleFragmentManager</code> assumes that each <code class="highlighter-rouge">Fragment</code> implements <code class="highlighter-rouge">IFragment</code> interface.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">IFragment</code> interface is forcing each <code class="highlighter-rouge">Fragment</code> to have its own unique <code class="highlighter-rouge">name</code> or <code class="highlighter-rouge">tag</code> under which is added to transaction, <code class="highlighter-rouge">dispose()</code> method (which is very handy when implementing <code class="highlighter-rouge">RxJava2</code>), and yes, method to <code class="highlighter-rouge">setTitle()</code> of the <code class="highlighter-rouge">Toolbar/ActionBar</code>.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">FragmentTagStack</code> to handle stack easily and retrieve fragments. It does not contain fragment instances, but its <code class="highlighter-rouge">tags</code> as <code class="highlighter-rouge">String</code> values instead and have only basic methods for <code class="highlighter-rouge">pop</code>, <code class="highlighter-rouge">popUpAll</code>, <code class="highlighter-rouge">peek</code>, <code class="highlighter-rouge">push</code> and <code class="highlighter-rouge">getActiveTag</code> which returns tag of currently shown <code class="highlighter-rouge">Fragment</code> on the screen.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">FragmentChannel</code> is the most basic interface for callback implementation between the <code class="highlighter-rouge">Fragment</code> and hosting environment, which can be <code class="highlighter-rouge">Activity</code> or parent <code class="highlighter-rouge">Fragment</code>.</p>
  </li>
</ul>

<p>And here is the sequence diagram that simplifies the explanation, that shows basic interaction with adding, replacing and removing fragments.</p>

<p><img src="http://localhost:4000/images/posts/2017/2017-06-08-fragmentdiagram.svg" alt="Sequence Diagram" /></p>

<p>It is obvious that implementation is really simple.
To make things even more easier, sources can be easily found by referencing the library in your <code class="highlighter-rouge">build.gradle</code> file: <code class="highlighter-rouge">implementation 'com.bajicdusko:fragment-manager:1.0.2'</code>.</p>

<p>You have the freedom to reimplement base classes for the activities and fragments, or you can extend already prepared <code class="highlighter-rouge">SFMActivity</code> and <code class="highlighter-rouge">SFMFragment</code> class which do all the work for you.</p>

<p>In case that you’re unable to extend these classes, these are the preconditions you have to prepare in your own class.</p>

<ol>
  <li>Activity initialize <code class="highlighter-rouge">SimpleFragmentManager</code>.
    <ul>
      <li>Override <code class="highlighter-rouge">onSaveInstanceState</code> and <code class="highlighter-rouge">onRestoreInstanceState</code> methods and forward the state to <code class="highlighter-rouge">SimpleFragmentManager</code>.</li>
      <li>Override <code class="highlighter-rouge">onBackPressed</code> method forward the call to <code class="highlighter-rouge">SimpleFragmentManager</code>.</li>
      <li>Implement <code class="highlighter-rouge">FragmentChannel</code>.</li>
    </ul>
  </li>
  <li>Each <code class="highlighter-rouge">Fragment</code> implements <code class="highlighter-rouge">IFragment</code> interface. <em>Tip: Usually, having <code class="highlighter-rouge">abstract BaseFragment</code> class which implements <code class="highlighter-rouge">IFragment</code> and initializes <code class="highlighter-rouge">FragmentChannel</code> is less error prone, then implementing these methods for all Fragments individually.</em></li>
</ol>

<p>Example implementation can be found in this <strong><a href="https://github.com/bajicdusko/SimpleFragmentManager">sample project</a></strong>. as well as implementations of described components below.
Once you establish hierarchy as below, you won’t have to think about it much. Only component that you’ll update constantly is <code class="highlighter-rouge">FragmentChannel</code> interface since you’ll be implementing all <code class="highlighter-rouge">Fragment</code> -&gt; <code class="highlighter-rouge">Activity</code> calls through it. <code class="highlighter-rouge">showLogin()</code> function in example below is one such case.</p>

<p><code class="highlighter-rouge">SimpleFragmentManager.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">SimpleFragmentManager</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">fragmentManager</span><span class="p">:</span> <span class="n">FragmentManager</span><span class="p">,</span> <span class="k">private</span> <span class="kd">val</span> <span class="py">fragmentContainerId</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">KEY_TAGS</span> <span class="p">=</span> <span class="s">"key_tags"</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">fragmentTagStack</span><span class="p">:</span> <span class="n">FragmentTagStack</span> <span class="p">=</span> <span class="n">FragmentTagStack</span><span class="p">()</span>

    <span class="k">constructor</span><span class="p">(</span><span class="n">fragmentManager</span><span class="p">:</span> <span class="n">FragmentManager</span><span class="p">,</span> <span class="n">fragmentContainer</span><span class="p">:</span> <span class="n">FrameLayout</span><span class="p">)</span> <span class="p">:</span> <span class="k">this</span><span class="p">(</span><span class="n">fragmentManager</span><span class="p">,</span> <span class="n">fragmentContainer</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">fun</span> <span class="nf">addFragment</span><span class="p">(</span><span class="n">fragment</span><span class="p">:</span> <span class="n">IFragment</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fragmentTagStack</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
        <span class="n">fragmentManager</span><span class="p">.</span><span class="n">beginTransaction</span><span class="p">()</span>
                <span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">fragmentContainerId</span><span class="p">,</span> <span class="n">fragment</span> <span class="k">as</span> <span class="n">Fragment</span><span class="p">,</span> <span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
                <span class="p">.</span><span class="n">addToBackStack</span><span class="p">(</span><span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
                <span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">replaceFragment</span><span class="p">(</span><span class="n">fragment</span><span class="p">:</span> <span class="n">IFragment</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fragmentTagStack</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
        <span class="n">fragmentManager</span><span class="p">.</span><span class="n">beginTransaction</span><span class="p">()</span>
                <span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">fragmentContainerId</span><span class="p">,</span> <span class="n">fragment</span> <span class="k">as</span> <span class="n">Fragment</span><span class="p">,</span> <span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
                <span class="p">.</span><span class="n">addToBackStack</span><span class="p">(</span><span class="n">fragment</span><span class="p">.</span><span class="n">getFragmentName</span><span class="p">())</span>
                <span class="p">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="cm">/**
     * When [Activity.onBackPressed] is called it is a good practice to override it and to call this method.
     * This method won't allow removal of last fragment on the stack.
     *
     * @return TRUE if fragment is poppedUp aka method is consumed, or FALSE if there is only one Fragment
     * on the stack.
     */</span>
    <span class="k">fun</span> <span class="nf">onBackPressed</span><span class="p">():</span> <span class="n">Boolean</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fragmentManager</span><span class="p">.</span><span class="n">backStackEntryCount</span> <span class="p">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">popUp</span><span class="p">()</span>
            <span class="kd">var</span> <span class="py">currentFragment</span> <span class="p">=</span> <span class="n">getCurrentFragment</span><span class="p">()</span>
            <span class="n">currentFragment</span><span class="o">?.</span><span class="n">setTitle</span><span class="p">()</span>
            <span class="k">return</span> <span class="k">true</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">popUp</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fragmentManager</span><span class="p">.</span><span class="n">popBackStackImmediate</span><span class="p">()</span>
        <span class="n">fragmentTagStack</span><span class="p">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">popUpAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">fragmentManager</span><span class="p">.</span><span class="n">popBackStack</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="n">FragmentManager</span><span class="p">.</span><span class="n">POP_BACK_STACK_INCLUSIVE</span><span class="p">)</span>
        <span class="n">fragmentTagStack</span><span class="p">.</span><span class="n">popUpAll</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">getCurrentFragment</span><span class="p">():</span> <span class="n">IFragment</span><span class="p">?</span> <span class="p">=</span> <span class="n">fragmentManager</span><span class="p">.</span><span class="n">findFragmentByTag</span><span class="p">(</span><span class="n">fragmentTagStack</span><span class="p">.</span><span class="n">activeTag</span><span class="p">)</span> <span class="k">as</span> <span class="n">IFragment</span><span class="p">?</span>

    <span class="k">fun</span> <span class="nf">dispose</span><span class="p">()</span> <span class="p">=</span> <span class="n">getCurrentFragment</span><span class="p">()</span><span class="o">?.</span><span class="n">dispose</span><span class="p">()</span>

    <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">state</span><span class="o">?.</span><span class="n">putParcelable</span><span class="p">(</span><span class="n">KEY_TAGS</span><span class="p">,</span> <span class="n">Parcels</span><span class="p">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">fragmentTagStack</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">onRestoreInstanceState</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">savedInstanceState</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fragmentTagStack</span> <span class="p">=</span> <span class="n">Parcels</span><span class="p">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">.</span><span class="n">getParcelable</span><span class="p">(</span><span class="n">KEY_TAGS</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">fragmentTagStack</span> <span class="p">=</span> <span class="n">FragmentTagStack</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">FragmentTagStack.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="n">@Parcel</span><span class="p">(</span><span class="n">Parcel</span><span class="p">.</span><span class="n">Serialization</span><span class="p">.</span><span class="n">BEAN</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">FragmentTagStack</span> <span class="p">{</span>

    <span class="n">@Transient</span> <span class="k">private</span> <span class="kd">var</span> <span class="py">showLogs</span><span class="p">:</span> <span class="n">Boolean</span> <span class="p">=</span> <span class="k">false</span>

    <span class="kd">var</span> <span class="py">tags</span><span class="p">:</span> <span class="n">MutableList</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;</span>
        <span class="k">private</span> <span class="k">set</span>

    <span class="kd">var</span> <span class="py">activeTag</span><span class="p">:</span> <span class="n">String</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
        <span class="k">private</span> <span class="k">set</span>

    <span class="k">constructor</span><span class="p">(){</span>
        <span class="n">tags</span> <span class="p">=</span> <span class="n">LinkedList</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="n">@ParcelConstructor</span>
    <span class="k">constructor</span><span class="p">(</span><span class="n">tags</span><span class="p">:</span> <span class="n">MutableList</span><span class="p">&lt;</span><span class="n">String</span><span class="p">&gt;,</span> <span class="n">activeTag</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">tags</span> <span class="p">=</span> <span class="n">tags</span>
        <span class="k">this</span><span class="p">.</span><span class="n">activeTag</span> <span class="p">=</span> <span class="n">activeTag</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Enabling or disabling fragment stack logs. Logs are disabled by default.

     * @param showLogs
     */</span>
    <span class="k">fun</span> <span class="nf">setShowLogs</span><span class="p">(</span><span class="n">showLogs</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="n">showLogs</span> <span class="p">=</span> <span class="n">showLogs</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Pushing new tag to stack and setting is as [FragmentTagStack.activeTag]

     * @param tag
     */</span>
    <span class="k">fun</span> <span class="nf">push</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">tags</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
        <span class="n">activeTag</span> <span class="p">=</span> <span class="n">tag</span>
        <span class="n">logStack</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Popping tag from the stack and setting the tag below as new [FragmentTagStack.activeTag]
     *
     *
     * Example:
     *
     *
     * Stack [3, 2, 1, 0] (3 is last added tag). [FragmentTagStack.activeTag] have value 3
     *
     *
     * Now we're popping the last added tag
     *
     *
     * Stack [2, 1, 0] [FragmentTagStack.activeTag] have value 2

     * @return Popped up value. From the example above, returned value will be 3. In case of empty stack, null will be returned.
     */</span>
    <span class="k">fun</span> <span class="nf">pop</span><span class="p">():</span> <span class="n">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">tag</span> <span class="p">=</span> <span class="n">peek</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">TextUtils</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">(</span><span class="n">tag</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">tags</span><span class="p">.</span><span class="n">removeAt</span><span class="p">(</span><span class="n">tags</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>
        <span class="p">}</span>

        <span class="n">activeTag</span> <span class="p">=</span> <span class="n">peek</span><span class="p">()</span>
        <span class="n">logStack</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">tag</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Peeking to the top of the stack, without data modification.

     * @return Value on top of the stack. If stack is empty, returned value will be null.
     */</span>
    <span class="k">fun</span> <span class="nf">peek</span><span class="p">():</span> <span class="n">String</span><span class="p">?</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tags</span><span class="p">.</span><span class="n">size</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">tags</span><span class="p">[</span><span class="n">tags</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="m">1</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">null</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">logStack</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">showLogs</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">stringBuilder</span> <span class="p">=</span> <span class="n">StringBuilder</span><span class="p">()</span>
            <span class="n">stringBuilder</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"Active tag: $activeTag\nStack:\n"</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="n">tags</span><span class="p">.</span><span class="n">size</span> <span class="p">-</span> <span class="m">1</span> <span class="n">downTo</span> <span class="m">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">stringBuilder</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"[ ${tags[i]}]\n"</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="n">stringBuilder</span><span class="p">.</span><span class="n">toString</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/**
     * Clears the stack.
     */</span>
    <span class="k">fun</span> <span class="nf">popUpAll</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">tags</span><span class="p">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">companion</span> <span class="kd">object</span> <span class="err">{

        </span><span class="nc">@Transient</span> <span class="k">private</span> <span class="kd">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="s">"FragmentTagStack"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">IFragment.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>
<span class="kd">interface</span> <span class="nc">IFragment</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">getFragmentName</span><span class="p">():</span> <span class="n">String</span>

    <span class="k">fun</span> <span class="nf">setTitle</span><span class="p">():</span> <span class="n">Unit</span><span class="p">?</span>

    <span class="k">fun</span> <span class="nf">dispose</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">FragmentChannel.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>
<span class="kd">interface</span> <span class="nc">FragmentChannel</span><span class="p">{</span>
  <span class="k">fun</span> <span class="nf">setTitle</span><span class="p">(</span><span class="n">title</span><span class="p">:</span> <span class="n">String</span><span class="p">):</span> <span class="n">Unit</span><span class="p">?</span>
  <span class="k">fun</span> <span class="nf">showLogin</span><span class="p">()</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">BaseFragment.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>
<span class="k">abstract</span> <span class="kd">class</span> <span class="nc">BaseFragment</span> <span class="p">:</span> <span class="n">Fragment</span><span class="p">(),</span> <span class="n">IFragment</span><span class="p">{</span>

  <span class="kd">var</span> <span class="py">fragmentChannel</span><span class="p">:</span> <span class="n">FragmentChannel</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">:</span> <span class="n">Context</span><span class="p">){</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onAttach</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">context</span> <span class="k">is</span> <span class="n">FragmentChannel</span><span class="p">){</span>
      <span class="n">fragmentChannel</span> <span class="p">=</span> <span class="n">context</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?){</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">parentFragment</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">parentFragment</span> <span class="k">is</span> <span class="n">FragmentChannel</span><span class="p">){</span>
      <span class="n">fragmentChannel</span> <span class="p">=</span> <span class="n">parentFragment</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">HomeFragment.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code>
<span class="kd">class</span> <span class="nc">HomeFragment</span> <span class="p">:</span> <span class="n">BaseFragment</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">private</span> <span class="kd">val</span> <span class="py">FRAGMENT_NAME</span> <span class="p">=</span> <span class="s">"Home"</span>

  <span class="k">companion</span> <span class="k">object</span><span class="p">{</span>
    <span class="k">fun</span> <span class="nf">newInstance</span><span class="p">()</span> <span class="p">=</span> <span class="n">HomeFragment</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">getFragmentName</span><span class="p">():</span> <span class="n">String</span> <span class="p">=</span> <span class="n">FRAGMENT_NAME</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">setTitle</span><span class="p">()</span> <span class="p">=</span> <span class="n">fragmentChannel</span><span class="o">?.</span><span class="n">setTitle</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">home</span><span class="p">)</span>

  <span class="k">fun</span> <span class="nf">onLoginButtonClick</span><span class="p">(){</span>
    <span class="n">fragmentChannel</span><span class="o">?.</span><span class="n">showLogin</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">dispose</span><span class="p">(){</span>
    <span class="n">TODO</span><span class="p">(</span><span class="s">"Call presenter dispose method"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">HomeActivity.kt</code></p>

<div class="language-kotlin highlighter-rouge"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">HomeActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">(),</span> <span class="n">FragmentChannel</span><span class="p">{</span>

  <span class="n">@BindView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_home_container</span><span class="p">)</span>
  <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">flContainer</span><span class="p">:</span> <span class="n">FrameLayout</span>

  <span class="kd">val</span> <span class="py">simpleFragmentManager</span> <span class="k">by</span> <span class="n">lazy</span> <span class="p">{</span>
    <span class="n">SimpleFragmentManager</span><span class="p">(</span><span class="n">getSupportFragmentManager</span><span class="p">(),</span> <span class="n">flContainer</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?){</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_home</span><span class="p">)</span>
    <span class="n">ButterKnife</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="n">simpleFragmentManager</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">HomeFragment</span><span class="p">.</span><span class="n">newInstance</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?){</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
    <span class="n">simpleFragmentManager</span><span class="p">.</span><span class="n">onSaveInstanceState</span><span class="p">(</span><span class="n">outState</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onRestoreInstanceState</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">:</span> <span class="n">Bundle</span><span class="p">?){</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onRestoreInstanceState</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">simpleFragmentManager</span><span class="p">.</span><span class="n">onRestoreInstanceState</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">setTitle</span><span class="p">(</span><span class="n">titleId</span><span class="p">:</span> <span class="n">Int</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">supportActionBar</span><span class="o">?.</span><span class="n">title</span> <span class="p">=</span> <span class="n">getString</span><span class="p">(</span><span class="n">titleId</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">showLogin</span><span class="p">(){</span>
    <span class="n">simpleFragmentManager</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">LoginFragment</span><span class="p">.</span><span class="n">newInstance</span><span class="p">())</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onBackPressed</span><span class="p">(){</span>
    <span class="k">if</span><span class="p">(!</span><span class="n">simpleFragmentManager</span><span class="p">.</span><span class="n">onBackPressed</span><span class="p">){</span>
      <span class="n">finish</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>And last but not least on latest Google IO (2017), guys from Google found it necessary to remind everyone about the basics as well.</p>

<div class="videoWrapper">
<iframe width="560" height="315" src="https://www.youtube.com/embed/eUG3VWnXFtg" frameborder="0" allowfullscreen=""></iframe>
</div>

  </section>
  <section id="disqus_thread"></section><!-- /#disqus_thread -->
</article>

    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://localhost:4000/2017/simplified-fragment-management/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = '/2017/simplified-fragment-management'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
      };

      (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//bajicdusko.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
       })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



      </div>

      <footer class="footer">
  <span class="footer__copyright">&copy; 2017 Dusko Bajic. All rights reserved.</span>
</footer>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/main.js"></script>


    </div>
  </body>
</html>
